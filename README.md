# FRA502 Service Robot Project: Final Presentation
> หุ่นยนต์สำหรับขนส่งกล่องพัสดุภายในคอนโด หุ่นจะรับพัสดุจากตำแหน่งรับพัสดุและนำไปส่งได้พร้อมกันไม่เกิน 2 ห้อง หุ่นยนต์จะรอเพื่อรับโค้ดเพื่อยืนยันตัวตนและเดินออกไปเมื่อพัสดุถูกหยิบไปและได้รับคำยืนยันจากผู้หยิบ
## The robot
หุ่นยนต์ที่ได้ออกแบบไว้จะมีลักษณะเป็นตู้กระจกบนและล่าง(แบบแรกออกแบบผิด) มีแผ่นกั้นด้านในสำหรับส่งได้ถึงสองห้อง มีการใช้ Lidar และมีล้อขับเคลื่อนแบบ differential drive

![This is an image](https://files.fm/thumb.php?i=prxcdfxvp)
![This is an image](https://files.fm/thumb.php?i=64hq4peu7)
## Code description
### 1. Environment
- OS: Ubuntu 20.04 LTS
- ROS: Noetic

### 2. Dependencies
- actionlib
- amcl
- gazebo_ros
- geometry_msgs
- map_server
- move_base_msgs
- std_ms
- rospy
- turtlebot3
- sensor_msgs
- sound_play

### 2. Python library
- pyaudio
- pttsx3
- SpeechRecognition

## Getting ready

เนื่องจากในตอนนี้หุ่นยนต์ที่ได้ทำขึ้นยังมีปัญหา จึงต้องใช้ turtle bot ในการรันใน gazebo
```
cd ~/[your_desire_catkin_workspace]/src
git clone https://github.com/notchap30/Delirobot
git clone https://github.com/ROBOTIS-GIT/turtlebot3.git
```
source file
```
cd ..
source devel/setup.bash
```
## Run gazebo and Rviz

การเปิด gazebo ด้วย Apartment world โดยภายในคำสั่งจะทำการเปิด Rviz ที่มีการตั้งค่าไว้ให้ และจะมีการ spawn หุ่นยนต์ให้โดยหุ่นยนต์ดังกล่าวคือ turtlebot burger model 

```
roslaunch delirobot world.launch
```

## Mapping
หลังจากที่ได้เปิด gazebo world แล้ว ให้รันคำสั่งเพื่อบังคับการเดินเพื่อเริ่มเก็บ map 
```
roslaunch delirobot teleop.launch
```
หลังจากทีเดินจะมีการจำแมพแสดงให้เห็นผ่านโปรแกรม rviz เมื่อเดินจนครบให้รันคำสั่งด้านล่างเพื่อบันทึก 
map ที่ถูกบันทึกจะถูกนำไปเก็บภายในโฟลเดอร์ชื่อว่า maps
```
rosrun map_server map_saver -f ~/[your_desire_catkin_workspace]/src/delirobot/maps/map
```
## All set! Try out the robot
การรันหุ่นยนต์จะต้องใช้ terminal ทั้งหมดสามช่องเพื่อรันไฟล์ .launch และไฟล์ .py แยกกันได้แก่

- world.launch
```
source devel/setup.bash
roslaunch delirobot world.launch
```
- navigation.launch
```
source devel/setup.bash
roslaunch delirobot_navigation delirobot_navigation.launch
```
- delispeech.py
```
source devel/setup.bash
rosrun delirobot delispeech.py
```
หน้าจอจะถูกแสดงขึ้นมาพร้อมกับหุ่นยนต์ในตำแหน่งรับพัสดุ

## Voice command
การใช้งานหุ่นยนต์จะแบ่งเป็นฝั่งของ user และ client userจะใช้งานเมื่อหุ่นยนต์อยู่ ณ ตำแหน่งรับพัสดุ และ client จะอยู่ที่ห้อง
 
### user command
ในฝั่งผู้ใช้จะเน้นการพิมพ์เนื่องจากมีคำสั่งที่ต้องใช้เยอะ ในช่วงที่ไม่ได้ทำอะไรหุ่นยนต์จะอยู่นิ่งๆจนกว่าจะถูกเรียก ในช่วงที่หุ่นยนต์อยู่นิ่ง โค้ดจะอยู่ในลูปสามารถสั่งคำสั่งให้จบการทำงานของไฟล์โดยใช้คำสั่ง
 - **delistop** (พิมพ์)

 คำสั่งในการเรียกหุ่นยนต์คือ
- **hey** (พิมพ์)
 หรือใช้การเรียกด้วยเสียงโดยพิมพ์คำสั่ง
- **delilisten** (พิมพ์)
ตามด้วย
- **hey** (พูด)

หลังจากนั้นหุ่นยนต์จะถามว่าต้องการให้ไปส่งกี่ห้อง 
- **1** หรือ **2** (พิมพ์)

หุ่นยนต์จะถามต่อว่าต้องการให้ทำอะไรต่อโดยจะเป็นการจัดการตัวหุ่นยนต์ สามารถสั่งการ(พิมพ์)ได้ต่อไปนี้
- **upper open** เป็นการเปิดฝาด้านบนของหุ่น
- **upper close** เป็นการปิดฝาด้านบนของหุ่น
- **lower open** เป็นการเปิดฝาด้านล่างของหุ่น
- **lower close** เป็นการปิดฝาด้านล่างของหุ่น
- **bigbox** เป็นการเปิดแผ่นที่กันทั้งสองช่อง
- **smallbox** เป็นการปิดแผ่นที่กันทั้งสองช่อง
- **ready** เพื่อไปคำสั่งต่อไป

หลังจากนั้นหุ่นยนต์จะถามว่าห้องที่ต้องการจะส่งอยู่ห้องไหนและจะถามตามจำนวนห้องที่ได้เลือกไว้ในตอนแรก
- **[พิมพ์เลขห้อง]** เพื่อบอกห้องที่ต้องการส่ง
หุ่นยนต์จะถามว่ายืนยันไหมให้พิมพ์ว่า
- **correct** หรือ **incorrect** (พิมพ์)
โดยถ้าเลือก incorrect ให้พิมพ์เลขห้องต่อได้เลย
หลังจากยืนยันเลขห้องทั้งหมดหุ่นยนต์จะยืนยันและเริ่มทำงาน

### client command
เมื่อหุ่นยนต์ถึงหน้าห้องหุ่นยนต์จะพูดว่าถึงเลขห้องและบอกให้พูดรหัสยืนยัน ที่ทำไว้รหัสเดียวสำหรับตอนนี้
- **123** คือรหัสที่ต้องพูดเพื่อยืนยัน
ถ้ารหัสถูกต้องหุ่นยนต์จะบอกว่าถ้าหยิบของเรียบร้อยให้พูดว่า
-**yes** เพื่อให้หุ่นทำงานต่อ
หุ่นยนต์จะบอกว่าลาก่อนและไปห้องต่อไปหรือกับฐาน
- 
## Problem
### Phrase 2 (virtual machine)
- **model ของหุ่นยนต์** defualt value จาก solidwork ทำให้ช่วงแรกในการเรียนรู้เกิดความสับสนเพราะเมื่อเปิดไฟล์ด้วย gazebo พบว่าหุ่นยนต์มี inetia ที่เอนไปทางเดียวและมีน้ำหนักมาก ทำให้ไม่แน่ใจว่าต้องแก้ไขอย่างไร รวมถึงการตั้งค่าแกนต่างๆให้เหมาะสม ทำให้สุดท้ายแล้วเลือกที่จะเขียนโมเดล urdf ขึ้นมาเองและใช้งานได้ตามความต้องการ
- **การเรียนรู้การใช้งาน ros/gazebo/rviz และ ubuntu** เนื่องจากเป็นเรื่องใหม่ที่ต้องเรียนรู้จึงสับสนการใช้งานไฟล์นามสกุลต่างๆ รวมไปถึงการใช้งาน plugin ต่างๆว่าต้องใส่อะไรในไฟล์ใด
- **Gazebo** ไม่สามารถสร้างประตูได้ และเกิดปัญหา save world ไม่ได้
### Phrase 3 (dual boost)
- **virtual machine** ไม่สามารถใช้งานได้ เมื่อทดลอง version ที่เก่ากว่าก็ไม่สามารถรันได้เช่นกัน จึงต้องเริ่มทำใหม่ตั้งแต่ต้นโดยใช้การ dual boost ควบคู่ไปกับ window
- **lidar** สามารถรับค่าได้แค่ด้านหน้าเพราะการออกแบบในช่วงแรก ทำให้ต้องลดขนาดของกล่องที่หุ่นยนต์ใส่ได้และวาง Lidar ไว้ด้านบนหัว
- **teleop** ทำงานอย่างที่ไม่เข้าใจ เนื่องจากใน phrase2 สร้างหุ่นยนต์เคลื่อนที่โดยใช้ bar เลื่อนและได้เลือกที่จะใช้งาน teleop ของ keyboard
- หุ่นยนต์ไม่เดิน ในช่วงแรกที่ทดลองนำมาใช้กับหุ่นยนต์แต่ล้อของหุ่นยนต์กลับไม่หมุน เมื่อพบว่า ros รับคำสั่งจริงและ rostopic ตรงกัน ทำให้ต้องตรวจสอบการวางแกนต่างๆ แต่เมื่อจัดการแกนต่างๆ หุ่นยนต์กลับเดินในท่าทางที่ประหลาด จนสุดท้ายพบว่ามีความผิดพลาดในการตั้งแกนจาก solidwork จึงกลับไปจัดการใหม่
  - สุดท้ายแล้วเมื่อใช้ teleop พบว่าหุ่นเดินไม่ตรงตามความต้องการ จึงเลือกใช้ turtlebot ในการเก็บค่าจากแมพเพื่อข้ามไปทำส่วนอื่นก่อน
- **Map** ที่ได้จากการ mapping ไม่ตรงกับ laser scan ของหุ่นที่ฉายใน gazebo พบว่าเกิดจากค่าในไฟล์ amcl.launch 
- เกิดปัญหาในการทำ **navigation**
  - หุ่นยนต์เดินชนผนังไม่ไปตามทางที่วาดเอาไว้ ในช่วงแรกเข้าใจว่าเป็นการออกแบบหุ่นยนต์ที่ผิดพลาดหรือล้อเล็กเกินไป จึงมีการทดลองออกแบบในหลายส่วน รวมไปถึงการทดลองการใช้จากไฟล์แบบอื่นๆ สุดท้ายแล้วเมื่อทดลองใช้ navigation จากturtlebot ก็เกิดผลลัพท์เช่นเดียวกัน นั่นคือหุ่นยนต์เดินติดกับผนังก่อนที่จะถึงจุดเลี้ยว จึงเลือกที่จะเขียนกันจากไฟล์ python ให้หุ่นยนต์พยายามที่เจอเดินเป็นเส้นตรง
  - แต่ทว่าเมื่อทดลองใช้ model ที่ตัวเองสร้างกับพบว่าต้องทดลองปรับค่าต่างๆเพื่อให์หุ่นยนต์เดินในทางที่เหมาะสมที่สุด เพราะหุ่นมีการเดินชนผนังและออกจากเส้นทางในหลายครั้ง แต่เมื่อทดลองพบว่าปัญหาต่างๆที่เจอลดลงบ้างแต่ไม่หมดไป รวมถึงได้ทดลองนำหุ่นยนต์ไปรวมกับหุ่นยนต์จากตัวอย่างอื่นๆ แต่ก็ไม่ทำให้ปัญหาหมดไป จึงต้องกลับไปใช้ turtlebot อย่างที่ได้กล่าวไว้ตั้งแต่หัวข้อ getting ready (ตัวอย่างปัญหาที่พบหลังจากแก้ไขครั้งสุดท้าย: https://youtu.be/FOV9eAkC9Kk)
- การรับเสียง บางครั้งรับเสียงช้าหรือประมวลผลนาน และเกิดปัญหาจาก accent ที่ไม่ดีพอที่จะทำให้หุ่นยนต์เข้าใจ (รวมถึงคำสั่ง "hey deli") และคำสั่งที่ใช้มีอยู่เยอะจึงเลือกใช้คำสั่งเสียงในบางขั้นตอนเท่านั้น
- เนื่องจากการจัดการเวลาที่ไม่ดี และขาดการประเมินงานของตัวเองทำให้ขาดรายละเอียดต่างๆตามไฟล์ proposal 
  - รายละเอียดของตัวหุ่น เช่น การเปิดปิดฝาตู้, การยก plate, หรือการแสดงไฟบนหุ่นยนต์เมื่อหุ่นเริ่มทำงาน
  - รายละเอียดใน python เช่น การทำคำสั่งกัน password, การสุ่ม password, การแบ่งชั้นของตู้
  - รายละเอียดใน map เนื่องจากเกิดปัญหาต่างๆจึงเลือกที่ทำ map ให้ simple ที่สุดเพื่อรันการทำงานเบื้องต้นก่อน 

## Example of the files
video: https://youtu.be/8g0V3-cT7CU
